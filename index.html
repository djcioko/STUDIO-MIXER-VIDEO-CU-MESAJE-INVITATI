<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MV STUDIO PRO - REBORN 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --main: #ffaa00; --msg-size: 26px; }
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; background: #000; overflow: hidden; font-family: sans-serif; color: white; }
        
        #viewport { position: relative; width: 100%; height: calc(100% - 250px); overflow: hidden; background: #000; border-bottom: 2px solid #333; }

        /* STRATURI FUNDAL */
        #bg-v, #bg-i, #bg-s { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; display: none; z-index: 1; }

        /* WEBCAM DEVICE (LIBER PENTRU AI CUT) */
        #cam-box { position: absolute; z-index: 10; cursor: move; display: none; }
        #v-src { width: 400px; height: auto; object-fit: contain; }

        /* VUMETRU + LOGO PNG/JPG */
        #circle-box { position: absolute; z-index: 15; cursor: move; width: 300px; height: 300px; display: flex; align-items: center; justify-content: center; }
        #radial-canvas { position: absolute; pointer-events: none; z-index: 16; }
        #inner-circle { 
            width: 150px; height: 150px; border-radius: 50%; 
            border: 2px solid var(--main); background: rgba(0,0,0,0.2); 
            overflow: hidden; display: flex; align-items: center; justify-content: center; z-index: 17;
        }
        #inner-img { width: 100%; height: 100%; object-fit: cover; display: none; }

        /* MESAJ FIREBASE */
        #msg-box {
            position: absolute; z-index: 999; background: rgba(0, 0, 0, 0.85); 
            border-left: 8px solid var(--main); padding: 20px; border-radius: 0 15px 15px 0; 
            min-width: 320px; cursor: move; display: none;
        }

        /* PANOU CONTROL (STILUL DIN POZA A) */
        #controls {
            position: absolute; bottom: 0; left: 0; right: 0; height: 250px;
            background: #1a1a1a; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 15px;
        }
        .panel { background: #222; padding: 10px; border-radius: 8px; border: 1px solid #333; display: flex; flex-direction: column; gap: 6px; }
        .panel h3 { font-size: 11px; color: var(--main); text-transform: uppercase; font-weight: bold; text-align: center; border-bottom: 1px solid #333; margin-bottom: 5px; }
        
        .btn { width: 100%; padding: 8px; font-weight: bold; border-radius: 4px; text-transform: uppercase; font-size: 10px; cursor: pointer; border: none; }
        .st-off { background: #ff0000; color: white; }
        .st-on { background: #00ff00; color: black; }
        .btn-white { background: #fff; color: #000; }
        .btn-blue { background: #2563eb; color: white; }

        input[type="file"] { font-size: 9px; background: #333; color: #fff; padding: 2px; border-radius: 3px; width: 100%; }
        input[type="range"] { accent-color: var(--main); height: 12px; }
        label { font-size: 9px; color: #aaa; }
    </style>
</head>
<body>

    <div id="viewport">
        <video id="bg-v" autoplay loop muted></video>
        <img id="bg-i">
        <img id="bg-s">

        <div id="cam-box" style="top:50px; right:50px;">
            <video id="v-src" autoplay playsinline></video>
        </div>

        <div id="circle-box" style="top:20%; left:35%;">
            <canvas id="radial-canvas" width="450" height="450"></canvas>
            <div id="inner-circle">
                <img id="inner-img">
            </div>
        </div>

        <div id="branding" style="bottom:120px; left:50px; position:absolute; font-weight:900; font-size:40px; text-shadow:2px 2px 10px #000; z-index:20; cursor:move;">PARTY LIVE</div>

        <div id="msg-box" style="top:100px; left:50px;">
            <span id="msg-user" style="color:var(--main); font-weight:bold;">INVITAT</span><br>
            <span id="msg-txt" style="font-size:var(--msg-size);">Mesaj...</span>
        </div>
    </div>

    <div id="controls">
        <div class="panel">
            <h3>1. FUNDAL MEDIA (FIȘIERE)</h3>
            <label>Video:</label><input type="file" accept="video/*" onchange="loadM(this, 'bg-v')">
            <label>Foto (single):</label><input type="file" accept="image/*" onchange="loadM(this, 'bg-i')">
            <label>Slideshow (multi):</label><input type="file" accept="image/*" multiple onchange="loadSlideFiles(this)">
        </div>

        <div class="panel">
            <h3>2. FUNDAL MEDIA (CONTROL)</h3>
            <button id="btn-v" class="btn st-off" onclick="toggleLayer('bg-v', 'btn-v')">VIDEO: OFF</button>
            <button id="btn-i" class="btn st-off" onclick="toggleLayer('bg-i', 'btn-i')">FOTO: OFF</button>
            <button id="btn-s" class="btn st-off" onclick="toggleLayer('bg-s', 'btn-s')">SLIDE: OFF</button>
            <label>Timp Slide (sec):</label>
            <input type="range" min="1" max="15" value="3" id="s-speed">
        </div>

        <div class="panel">
            <h3>3. WEBCAM & AI</h3>
            <button class="btn btn-white" onclick="initCam()">START WEBCAM</button>
            <button id="btn-ai" class="btn st-on" style="background:#00ff00; color:#000;">AI CUT: ON</button>
            <button id="btn-cam" class="btn st-off" onclick="toggleCam()">CAM ÎN CERC: OFF</button>
            <label>Mărime Cameră:</label>
            <input type="range" min="200" max="1200" value="400" oninput="document.getElementById('v-src').style.width=this.value+'px'">
        </div>

        <div class="panel">
            <h3>4. CERC & VU-METRU</h3>
            <button id="btn-png" class="btn st-off" onclick="togglePng()">POZĂ CERC: OFF</button>
            <input type="file" accept="image/*" onchange="loadPng(this)">
            <label>Mărime Cerc:</label>
            <input type="range" min="0.5" max="2" step="0.1" value="1" oninput="document.getElementById('circle-box').style.transform=`scale(${this.value})` ">
        </div>

        <div class="panel">
            <h3>5. SISTEM & TEXT</h3>
            <input type="text" value="PARTY LIVE" class="bg-black text-white p-1 text-xs" oninput="document.getElementById('branding').innerText=this.value">
            <label>Scalare Text:</label>
            <input type="range" min="20" max="100" value="40" oninput="document.getElementById('branding').style.fontSize=this.value+'px'">
            <button class="btn btn-blue" onclick="goFS()">FULL SCREEN</button>
            <button class="btn st-off" onclick="location.reload()">RESET ALL</button>
        </div>
    </div>

<script>
    firebase.initializeApp({ databaseURL: "https://felicitari-nunta-default-rtdb.firebaseio.com" });
    let db = firebase.database().ref('test_dj');
    let mTimer, sTimer, sFiles = [], sIdx = 0;

    function goFS() { let v = document.getElementById('viewport'); if (v.requestFullscreen) v.requestFullscreen(); else if (v.webkitRequestFullscreen) v.webkitRequestFullscreen(); }

    // --- LOGICA FUNDALURI ---
    function loadM(input, id) { document.getElementById(id).src = URL.createObjectURL(input.files[0]); }
    function loadSlideFiles(input) { sFiles = Array.from(input.files).map(f => URL.createObjectURL(f)); }

    function toggleLayer(id, btnId) {
        let el = document.getElementById(id), btn = document.getElementById(btnId), isOff = el.style.display !== 'block';
        ['bg-v','bg-i','bg-s'].forEach(x => document.getElementById(x).style.display = 'none');
        ['btn-v','btn-i','btn-s'].forEach(x => { let b = document.getElementById(x); b.className = 'btn st-off'; b.innerText = b.innerText.split(':')[0] + ': OFF'; });
        if(sTimer) clearTimeout(sTimer);
        if(isOff) {
            el.style.display = 'block'; btn.className = 'btn st-on'; btn.innerText = btn.innerText.split(':')[0] + ': ON';
            if(id === 'bg-s') startSlideshow();
        }
    }

    function startSlideshow() {
        if(!sFiles.length) return;
        document.getElementById('bg-s').src = sFiles[sIdx];
        sIdx = (sIdx + 1) % sFiles.length;
        sTimer = setTimeout(startSlideshow, document.getElementById('s-speed').value * 1000);
    }

    // --- LOGICA CAMERA ---
    function toggleCam() {
        let c = document.getElementById('cam-box'), b = document.getElementById('btn-cam');
        if(c.style.display === 'block') { c.style.display='none'; b.className='btn st-off'; b.innerText='CAM ÎN CERC: OFF'; }
        else { c.style.display='block'; b.className='btn st-on'; b.innerText='CAM ÎN CERC: ON'; }
    }

    function loadPng(input) { let img = document.getElementById('inner-img'); img.src = URL.createObjectURL(input.files[0]); img.style.display='block'; }
    function togglePng() {
        let img = document.getElementById('inner-img'), b = document.getElementById('btn-png');
        if(img.style.display === 'block') { img.style.display='none'; b.className='btn st-off'; b.innerText='POZĂ CERC: OFF'; }
        else { img.style.display='block'; b.className='btn st-on'; b.innerText='POZĂ CERC: ON'; }
    }

    function initCam() {
        navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
            document.getElementById('v-src').srcObject = stream;
            const ctx = new AudioContext(), src = ctx.createMediaStreamSource(stream), ans = ctx.createAnalyser();
            ans.fftSize = 256; src.connect(ans);
            const data = new Uint8Array(ans.frequencyBinCount);
            function draw() {
                requestAnimationFrame(draw); ans.getByteFrequencyData(data);
                const can = document.getElementById('radial-canvas'), c = can.getContext('2d');
                c.clearRect(0,0,450,450);
                let sum = 0; for(let i=0; i<20; i++) sum += data[i];
                document.getElementById('circle-box').style.transform = `scale(${1 + (sum/20/255)*0.15})`;
                c.strokeStyle = '#ffaa00'; c.lineWidth = 4;
                for(let i=0; i<60; i++){
                    let a = (i*6)*Math.PI/180, l = data[i] * 0.45;
                    c.beginPath(); c.moveTo(225+Math.cos(a)*85, 225+Math.sin(a)*85);
                    c.lineTo(225+Math.cos(a)*(85+l), 225+Math.sin(a)*(85+l)); c.stroke();
                }
            } draw(); listen();
        });
    }

    function listen() {
        db.limitToLast(1).on('child_added', (sn) => {
            const d = sn.val(), box = document.getElementById('msg-box');
            document.getElementById('msg-user').innerText = d.author;
            document.getElementById('msg-txt').innerText = `"${d.text}"`;
            box.style.display = 'block';
            if(mTimer) clearTimeout(mTimer);
            mTimer = setTimeout(() => { box.style.display = 'none'; }, 8000);
        });
    }

    function drag(e) {
        let p1=0, p2=0, p3=0, p4=0;
        e.onmousedown = (m) => {
            if(m.target.tagName === 'INPUT' || m.target.tagName === 'BUTTON') return;
            p3=m.clientX; p4=m.clientY;
            document.onmouseup = () => { document.onmouseup=null; document.onmousemove=null; };
            document.onmousemove = (m) => {
                p1=p3-m.clientX; p2=p4-m.clientY; p3=m.clientX; p4=m.clientY;
                e.style.top=(e.offsetTop-p2)+"px"; e.style.left=(e.offsetLeft-p1)+"px";
            };
        };
    }
    [document.getElementById('msg-box'), document.getElementById('circle-box'), document.getElementById('cam-box'), document.getElementById('branding')].forEach(drag);
</script>
</body>
</html>
