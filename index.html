<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MV STUDIO ULTIMATE - MESSAGES EDITION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { 
            --main-color: #ffaa00; 
            --pulse: 1; 
            --cerc-scale: 1; 
            --cam-scale: 1; 
            --text-scale: 1;
        }
        body { 
            background: #000; color: white; font-family: 'Arial', sans-serif; 
            margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; 
        }

        #viewport {
            position: relative; width: 854px; height: 480px; 
            background: #050505; overflow: hidden; border: 2px solid #333;
            z-index: 1; box-shadow: 0 0 20px rgba(0,0,0,0.5); margin-top: 10px;
        }
        #viewport:fullscreen { width: 100vw; height: 100vh; border: none; display: flex; align-items: center; justify-content: center; background: black; }

        /* STRATURI FUNDAL */
        #bg-video, #bg-img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; display: none; filter: brightness(0.7); transition: opacity 0.5s; }
        #color-overlay { position: absolute; inset: 0; background: var(--main-color); mix-blend-mode: overlay; opacity: 0.4; z-index: 2; pointer-events: none; }

        /* WEBCAM */
        #webcam-layer { position: absolute; width: 240px; height: 180px; z-index: 10; cursor: grab; transform: scale(var(--cam-scale)); transition: border-radius 0.4s; }
        #webcam-layer.in-circle { width: 160px !important; height: 160px !important; border-radius: 50% !important; position: relative !important; z-index: 17; }
        #ai-canvas { width: 100%; height: 100%; object-fit: cover; }

        /* CERC & VU-METRU */
        #circle-group { position: absolute; width: 300px; height: 300px; z-index: 15; cursor: grab; display: flex; align-items: center; justify-content: center; transform: scale(calc(var(--pulse) * var(--cerc-scale))); }
        #radial-canvas { position: absolute; top: -50px; left: -50px; width: 400px; height: 400px; pointer-events: none; }
        #inner-circle { width: 160px; height: 160px; border-radius: 50%; border: 5px solid var(--main-color); overflow: hidden; z-index: 16; background: #000; display: flex; align-items: center; justify-content: center; }
        #inner-img { width: 100%; height: 100%; object-fit: cover; display: none; }

        #draggable-text { position: absolute; z-index: 20; cursor: grab; font-size: 35px; font-weight: bold; text-shadow: 0 0 15px var(--main-color); white-space: nowrap; transform: scale(var(--text-scale)); }

        /* NOU: CASETA MESAJE FIREBASE */
        #message-layer {
            position: absolute; z-index: 25; cursor: grab;
            background: rgba(0,0,0,0.8); border-left: 5px solid var(--main-color);
            padding: 15px 25px; border-radius: 0 15px 15px 0;
            max-width: 400px; display: none; /* Ascuns implicit */
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #msg-author { color: var(--main-color); font-weight: bold; font-size: 18px; display: block; }
        #msg-text { color: white; font-size: 22px; font-style: italic; }

        /* UI CONTROLS */
        .ui-container { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; width: 854px; background: #1a1a1a; padding: 15px; border-top: 3px solid var(--main-color); margin-top: 10px; }
        .cube { background: #252525; border: 1px solid #333; padding: 10px; border-radius: 8px; display: flex; flex-direction: column; gap: 8px; }
        h4 { margin: 0; font-size: 11px; color: var(--main-color); text-align: center; border-bottom: 1px solid #333; padding-bottom: 5px; text-transform: uppercase; }
        button { background: #3a3a3a; color: white; border: 1px solid #555; padding: 8px; cursor: pointer; font-size: 10px; font-weight: bold; border-radius: 4px; }
        button.btn-on { background: #00ff00 !important; color: black !important; }
        button.btn-off { background: #ff0000 !important; color: white !important; }
        input[type="range"], input[type="text"], input[type="color"] { width: 100%; background: #333; color: white; border: 1px solid #444; font-size: 10px; }
        span { font-size: 9px; color: #aaa; }
    </style>
</head>
<body>

    <div id="viewport">
        <video id="bg-video" autoplay loop muted></video>
        <img id="bg-img">
        <div id="color-overlay"></div>
        
        <div id="webcam-layer" style="top:20px; left:20px;"><canvas id="ai-canvas"></canvas></div>
        
        <div id="circle-group" style="top:90px; left:270px;">
            <canvas id="radial-canvas" width="450" height="450"></canvas>
            <div id="inner-circle"><img id="inner-img" src=""></div>
        </div>

        <div id="draggable-text" style="bottom:30px; left:300px;">STUDIO MV PRO</div>

        <div id="message-layer" style="top:50px; left:50px;">
            <span id="msg-author">NUME</span>
            <span id="msg-text">Mesaj live aici...</span>
        </div>
    </div>

    <div class="ui-container">
        <div class="cube">
            <h4>1. Video Fundal</h4>
            <input type="file" id="file-video" accept="video/*" onchange="loadVideo(this)">
            <button id="btn-video" class="btn-off" onclick="toggleVideoBackground()">VIDEO: OFF</button>
        </div>
        <div class="cube">
            <h4>2. Foto Fundal</h4>
            <input type="file" id="file-photo" accept="image/*" onchange="loadPhoto(this)">
            <button id="btn-foto" class="btn-off" onclick="togglePhotoBackground()">FOTO: OFF</button>
        </div>
        <div class="cube">
            <h4>3. Slideshow</h4>
            <input type="file" id="file-slides" multiple accept="image/*" onchange="loadSlides(this)">
            <button id="btn-slide" class="btn-off" onclick="toggleSlideshow()">SLIDE: OFF</button>
            <span>Sec:</span>
            <input type="range" min="1" max="10" value="4" oninput="setSlideTime(this.value)">
        </div>
        <div class="cube">
            <h4>4. Webcam & AI</h4>
            <button onclick="initCam()" style="background:var(--main-color); color:black">START CAM</button>
            <button id="btn-ai" class="btn-off" onclick="toggleAI()">AI: OFF</button>
            <button id="btn-mode" class="btn-off" onclick="toggleCamMode()">CERC: OFF</button>
            <input type="range" min="0.5" max="3" step="0.1" value="1" oninput="setCamScale(this.value)">
        </div>
        <div class="cube">
            <h4>5. Cerc & VU</h4>
            <button id="btn-ic" class="btn-off" onclick="toggleInnerImage()">POZĂ: OFF</button>
            <input type="file" accept="image/*" onchange="loadInnerImage(this)">
            <span>Mărime:</span>
            <input type="range" min="0.5" max="3" step="0.1" value="1" oninput="setCercScale(this.value)">
            <span>Bounce:</span>
            <input type="range" min="0" max="10" step="0.5" value="4" oninput="setBouncePower(this.value)">
        </div>

        <div class="cube">
            <h4>6. Sistem & Mesaje</h4>
            <input type="text" placeholder="Nume Studio..." oninput="updateText(this.value)">
            <span style="color:var(--main-color)">ID EVENIMENT:</span>
            <input type="text" id="event-id" value="test_dj" onchange="updateEventID(this.value)">
            <span>DURATĂ MESAJ (SEC):</span>
            <input type="range" min="3" max="30" value="10" id="msg-duration" oninput="updateMsgDuration(this.value)">
            <span id="dur-val">10 sec</span>
            <input type="color" value="#ffaa00" oninput="updateColor(this.value)">
            <button onclick="goFull()" style="background:#2563eb">FULL SCREEN</button>
        </div>
    </div>

    <video id="hidden-video" style="display:none" autoplay muted playsinline></video>
    <canvas id="offscreen-canvas" style="display:none;"></canvas>

<script>
    // --- State & Config ---
    let mainColor = localStorage.getItem('mainColor') || '#ffaa00';
    let cercScale = 1, camScale = 1, textScale = 1, bouncePower = 4;
    let eventID = localStorage.getItem('eventID') || 'test_dj';
    let msgDuration = parseInt(localStorage.getItem('msgDuration') || '10');
    let msgTimeout = null;

    // Firebase Init
    const firebaseConfig = {
        databaseURL: "https://felicitari-nunta-default-rtdb.firebaseio.com",
    };
    firebase.initializeApp(firebaseConfig);
    let db = firebase.database().ref(eventID);

    // --- Funcții Mesaje ---
    function updateEventID(val) {
        eventID = val;
        localStorage.setItem('eventID', val);
        db.off(); // oprim ascultarea pe vechiul ID
        db = firebase.database().ref(eventID);
        startListening();
    }

    function updateMsgDuration(val) {
        msgDuration = val;
        document.getElementById('dur-val').innerText = val + " sec";
        localStorage.setItem('msgDuration', val);
    }

    function startListening() {
        db.on('limitToLast', db.limitToLast(1), 'child_added', (snap) => {
            const data = snap.val();
            if(data) {
                showLiveMessage(data.author, data.text);
            }
        });
    }

    function showLiveMessage(author, text) {
        const layer = document.getElementById('message-layer');
        document.getElementById('msg-author').innerText = author.toUpperCase();
        document.getElementById('msg-text').innerText = `"${text}"`;
        
        layer.style.display = 'block';
        
        if(msgTimeout) clearTimeout(msgTimeout);
        msgTimeout = setTimeout(() => {
            layer.style.display = 'none';
        }, msgDuration * 1000);
    }

    // --- Integrare Draggable pentru Mesaje ---
    function makeDraggable(el, storageKey) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        
        // Restore position
        const savedPos = JSON.parse(localStorage.getItem('pos_' + storageKey));
        if (savedPos) {
            el.style.top = savedPos.top;
            el.style.left = savedPos.left;
        }

        el.onmousedown = (e) => {
            if(e.target.tagName === 'INPUT') return;
            e.preventDefault();
            pos3 = e.clientX; pos4 = e.clientY;
            document.onmouseup = () => {
                document.onmouseup = null;
                document.onmousemove = null;
                localStorage.setItem('pos_' + storageKey, JSON.stringify({top: el.style.top, left: el.style.left}));
            };
            document.onmousemove = (e) => {
                pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
                pos3 = e.clientX; pos4 = e.clientY;
                el.style.top = (el.offsetTop - pos2) + "px";
                el.style.left = (el.offsetLeft - pos1) + "px";
            };
        };
    }

    // --- Initializare ---
    window.onload = () => {
        // ... (Toate initializarile din codul 1)
        makeDraggable(document.getElementById('circle-group'), 'circle');
        makeDraggable(document.getElementById('webcam-layer'), 'webcam');
        makeDraggable(document.getElementById('draggable-text'), 'text');
        makeDraggable(document.getElementById('message-layer'), 'message'); // Caseta mesaje e acum mobila
        
        document.getElementById('event-id').value = eventID;
        document.getElementById('msg-duration').value = msgDuration;
        document.getElementById('dur-val').innerText = msgDuration + " sec";
        
        startListening();
    };

    // --- Toate functiile tale din MV Studio raman aici neschimbate ---
    // (loadVideo, loadPhoto, toggleAI, initCam, setupAudio, etc.)
    // Adaugă aici restul de funcții JavaScript din primul cod pe care l-ai trimis
    // ...
</script>
</body>
</html>