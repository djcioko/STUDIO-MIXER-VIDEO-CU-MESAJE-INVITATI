<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MV STUDIO PRO - REPARAT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --main: #ffaa00; --msg-size: 26px; }
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; background: #000; overflow: hidden; font-family: sans-serif; color: white; }
        #viewport { position: relative; width: 100%; height: calc(100% - 250px); overflow: hidden; background: #000; border-bottom: 2px solid #333; }

        /* STRATURI FUNDAL */
        #bg-v, #bg-i, #bg-s { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; display: none; z-index: 1; }

        /* WEBCAM AI CUT */
        #cam-box { position: absolute; z-index: 10; cursor: move; display: none; top: 50px; right: 50px; }
        #v-src { width: 500px; height: auto; object-fit: contain; background: transparent; }
        /* CSS for AI Cut glow effect */
        .ai-cut-glow {
            box-shadow: 0 0 10px 5px var(--main), 0 0 20px 10px rgba(255,170,0,0.5);
            animation: pulse-glow 1.5s infinite alternate;
        }
        @keyframes pulse-glow {
            from { box-shadow: 0 0 5px 2px var(--main), 0 0 10px 5px rgba(255,170,0,0.3); }
            to { box-shadow: 0 0 15px 8px var(--main), 0 0 30px 15px rgba(255,170,0,0.8); }
        }

        /* VUMETRU */
        #circle-box { position: absolute; z-index: 15; cursor: move; width: 300px; height: 300px; display: flex; align-items: center; justify-content: center; top: 10%; left: 30%; }
        #radial-canvas { position: absolute; pointer-events: none; z-index: 16; }
        #inner-circle { width: 150px; height: 150px; border-radius: 50%; border: 2px solid var(--main); background: rgba(0,0,0,0.2); overflow: hidden; display: flex; align-items: center; justify-content: center; z-index: 17; }
        #inner-img { width: 100%; height: 100%; object-fit: cover; display: none; }

        /* TEXT PERSONALIZAT - REPARAT PENTRU MUTARE */
        #branding { position: absolute; z-index: 20; cursor: move; font-weight: 900; text-transform: uppercase; text-shadow: 2px 2px 10px #000; bottom: 100px; left: 50px; white-space: nowrap; pointer-events: auto; }

        /* MESAJ FIREBASE */
        #msg-box { position: absolute; z-index: 999; background: rgba(0, 0, 0, 0.85); border-left: 8px solid var(--main); padding: 20px; border-radius: 0 15px 15px 0; min-width: 320px; cursor: move; display: none; top: 200px; left: 50px; }

        /* PANOU CONTROL */
        #controls { position: absolute; bottom: 0; left: 0; right: 0; height: 250px; background: #111; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 15px; }
        .panel { background: #1a1a1a; padding: 10px; border-radius: 8px; border: 1px solid #333; display: flex; flex-direction: column; gap: 5px; }
        .panel h3 { font-size: 10px; color: var(--main); text-transform: uppercase; font-weight: bold; text-align: center; border-bottom: 1px solid #333; margin-bottom: 4px; }
        .btn { width: 100%; padding: 7px; font-weight: bold; border-radius: 4px; text-transform: uppercase; font-size: 9px; cursor: pointer; border: none; }
        .st-off { background: #ff0000; color: white; }
        .st-on { background: #00ff00; color: black; }
        .btn-blue { background: #2563eb; color: white; }
        label { font-size: 9px; color: #888; margin-top: 2px; }
        input[type="range"], input[type="text"] { accent-color: var(--main); background: #000; color: #fff; border: 1px solid #444; padding: 3px; font-size: 10px; }
    </style>
<script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/"
  }
}
</script>
</head>
<body>

<div id="viewport">
    <video id="bg-v" autoplay loop muted></video>
    <img id="bg-i">
    <img id="bg-s">

    <div id="cam-box"><video id="v-src" autoplay playsinline></video></div>

    <div id="circle-box">
        <canvas id="radial-canvas" width="450" height="450"></canvas>
        <div id="inner-circle"><img id="inner-img"></div>
    </div>

    <div id="branding">STUDIO MV</div>

    <div id="msg-box">
        <span id="msg-user" style="color:var(--main); font-weight:bold;">INVITAT</span><br>
        <span id="msg-txt" style="font-size:var(--msg-size);">Mesaj nou...</span>
    </div>
</div>

<div id="controls">
    <div class="panel">
        <h3>1. MEDIA UPLOAD</h3>
        <label>Video/Foto:</label><input type="file" onchange="loadF(this, 'bg-v')">
        <label>Folder Slide:</label><input type="file" webkitdirectory directory multiple onchange="loadFolder(this)">
    </div>

    <div class="panel">
        <h3>2. CONTROL FUNDAL</h3>
        <button id="btn-v" class="btn st-off" onclick="tgL('bg-v', 'btn-v')">VIDEO: OFF</button>
        <button id="btn-i" class="btn st-off" onclick="tgL('bg-i', 'btn-i')">FOTO: OFF</button>
        <button id="btn-s" class="btn st-off" onclick="tgL('bg-s', 'btn-s')">SLIDE: OFF</button>
        <label>Viteză Slide:</label><input type="range" min="1" max="15" value="3" id="s-spd">
    </div>

    <div class="panel">
        <h3>3. WEBCAM & AI CUT</h3>
        <button class="btn btn-blue" onclick="initC()">START CAMERA</button>
        <button id="btn-cam" class="btn st-off" onclick="tgC()">AFIȘEAZĂ CAM: OFF</button>
        <button id="btn-aic" class="btn st-off" onclick="tgAICut()">AI CUT: OFF</button> <!-- NEW AI CUT BUTTON -->
        <label>Mărime:</label><input type="range" min="200" max="1500" value="500" oninput="document.getElementById('v-src').style.width=this.value+'px'">
        <label>Opacitate:</label><input type="range" min="0" max="1" step="0.1" value="1" oninput="document.getElementById('cam-box').style.opacity=this.value">
    </div>

    <div class="panel">
        <h3>4. CERC VUMETRU</h3>
        <button id="btn-png" class="btn st-off" onclick="tgP()">LOGO CERC: OFF</button>
        <input type="file" onchange="loadP(this)">
        <label>Mărime Cerc:</label><input type="range" min="0.5" max="2" step="0.1" value="1" id="v-scale" oninput="document.getElementById('circle-box').style.transform=`scale(${this.value})` ">
    </div>

    <div class="panel">
        <h3>5. TEXT & SISTEM</h3>
        <label>Scrie Text Ecran:</label>
        <input type="text" id="text-input" placeholder="STUDIO MV" oninput="document.getElementById('branding').innerText = this.value">
        <label>Mărime Text:</label>
        <input type="range" min="20" max="150" value="40" oninput="document.getElementById('branding').style.fontSize=this.value+'px'">
        <button class="btn btn-blue mt-2" onclick="goFS()">FULL SCREEN</button>
        <label>Mărime Mesaj FB:</label>
        <input type="range" min="15" max="80" value="26" oninput="document.documentElement.style.setProperty('--msg-size', this.value+'px')">
        <label>Timp Afișare:</label>
        <input type="range" min="2" max="30" value="8" id="m-time">
    </div>
</div>

<script>
    firebase.initializeApp({ databaseURL: "https://felicitari-nunta-default-rtdb.firebaseio.com" });
    let db = firebase.database().ref('test_dj');
    let mTim, sTim, sFiles = [], sIdx = 0;
    let isAICutActive = false; // NEW global state for AI Cut

    function goFS() { let v = document.getElementById('viewport'); if (v.requestFullscreen) v.requestFullscreen(); else if (v.webkitRequestFullscreen) v.webkitRequestFullscreen(); }

    function loadF(i, id) { 
        const file = i.files[0]; if(!file) return; 
        const url = URL.createObjectURL(file);
        if(file.type.startsWith('image')) { document.getElementById('bg-i').src = url; }
        else { document.getElementById('bg-v').src = url; document.getElementById('bg-v').load(); document.getElementById('bg-v').play(); }
    }

    function loadFolder(i) { sFiles = Array.from(i.files).filter(f => f.type.startsWith('image/')).map(f => URL.createObjectURL(f)); }

    function tgL(id, bId) {
        let el = document.getElementById(id), btn = document.getElementById(bId), isOff = el.style.display !== 'block';
        ['bg-v','bg-i','bg-s'].forEach(x => document.getElementById(x).style.display = 'none');
        ['btn-v','btn-i','btn-s'].forEach(x => { let b = document.getElementById(x); b.className='btn st-off'; b.innerText=b.innerText.split(':')[0]+': OFF'; });
        if(sTim) clearTimeout(sTim);
        if(isOff) { el.style.display = 'block'; btn.className = 'btn st-on'; btn.innerText = btn.innerText.split(':')[0] + ': ON'; if(id === 'bg-s') startS(); }
    }

    function startS() { if(!sFiles.length) return; document.getElementById('bg-s').src = sFiles[sIdx]; sIdx = (sIdx + 1) % sFiles.length; sTim = setTimeout(startS, document.getElementById('s-spd').value * 1000); }

    function initC() {
        navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
            document.getElementById('v-src').srcObject = stream;
            // Ensure audio context is only created once and for the stream that should be analyzed
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const src = ctx.createMediaStreamSource(stream);
            const ans = ctx.createAnalyser();
            ans.fftSize = 256; src.connect(ans);
            ans.connect(ctx.destination); // Connect to destination to ensure processing
            const data = new Uint8Array(ans.frequencyBinCount);
            function draw() {
                requestAnimationFrame(draw); ans.getByteFrequencyData(data);
                const can = document.getElementById('radial-canvas'), c = can.getContext('2d');
                c.clearRect(0,0,450,450);
                let sum = 0; for(let i=0; i<20; i++) sum += data[i];
                let sc = document.getElementById('v-scale').value;
                document.getElementById('circle-box').style.transform = `scale(${sc * (1 + (sum/20/255)*0.15)})`;
                c.strokeStyle = 'var(--main)'; c.lineWidth = 4; // Using CSS variable
                for(let i=0; i<60; i++){ let a = (i*6)*Math.PI/180, l = data[i] * 0.45; c.beginPath(); c.moveTo(225+Math.cos(a)*85, 225+Math.sin(a)*85); c.lineTo(225+Math.cos(a)*(85+l), 225+Math.sin(a)*(85+l)); c.stroke(); }
            } draw(); listen();
        }).catch(err => {
            console.error('Error accessing webcam or microphone:', err);
            alert('Nu s-a putut accesa camera web sau microfonul. Asigură-te că permisiunile sunt acordate.');
        });
    }

    // NEW AI CUT TOGGLE FUNCTION
    function tgAICut() {
        let video = document.getElementById('v-src');
        let btn = document.getElementById('btn-aic');
        isAICutActive = !isAICutActive;
        if (isAICutActive) {
            video.classList.add('ai-cut-glow');
            btn.className = 'btn st-on';
            btn.innerText = 'AI CUT: ON';
        } else {
            video.classList.remove('ai-cut-glow');
            btn.className = 'btn st-off';
            btn.innerText = 'AI CUT: OFF';
        }
    }

    function tgC() { let c = document.getElementById('cam-box'), b = document.getElementById('btn-cam'); if(c.style.display === 'block') { c.style.display='none'; b.className='btn st-off'; b.innerText='AFIȘEAZĂ CAM: OFF'; } else { c.style.display='block'; b.className='btn st-on'; b.innerText='AFIȘEAZĂ CAM: ON'; } }
    function loadP(i) { let img = document.getElementById('inner-img'); img.src = URL.createObjectURL(i.files[0]); img.style.display='block'; }
    function tgP() { let img = document.getElementById('inner-img'), b = document.getElementById('btn-png'); if(img.style.display === 'block') { img.style.display='none'; b.className='btn st-off'; b.innerText='LOGO CERC: OFF'; } else { img.style.display='block'; b.className='btn st-on'; b.innerText='LOGO CERC: ON'; } }

    function listen() {
        db.limitToLast(1).on('child_added', (sn) => {
            const d = sn.val(), box = document.getElementById('msg-box');
            document.getElementById('msg-user').innerText = d.author;
            document.getElementById('msg-txt').innerText = `"${d.text}"`;
            box.style.display = 'block'; if(mTim) clearTimeout(mTim);
            mTim = setTimeout(() => { box.style.display = 'none'; }, document.getElementById('m-time').value * 1000);
        });
    }

    // --- DRAG & DROP REPARAT ---
    function drag(e) {
        let p1=0, p2=0, p3=0, p4=0;
        e.onmousedown = (m) => {
            if(m.target.tagName === 'INPUT' || m.target.tagName === 'BUTTON' || m.target.closest('input') || m.target.closest('button')) return;
            p3=m.clientX; p4=m.clientY;
            document.onmouseup = () => { document.onmouseup=null; document.onmousemove=null; };
            document.onmousemove = (m) => { p1=p3-m.clientX; p2=p4-m.clientY; p3=m.clientX; p4=m.clientY; e.style.top=(e.offsetTop-p2)+"px"; e.style.left=(e.offsetLeft-p1)+"px"; };
        };
    }
    [document.getElementById('msg-box'), document.getElementById('circle-box'), document.getElementById('cam-box'), document.getElementById('branding')].forEach(drag);
</script>
</body>
</html>
