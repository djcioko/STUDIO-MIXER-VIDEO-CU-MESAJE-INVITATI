<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MV STUDIO ULTIMATE - FIX EDITION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --main-color: #ffaa00; --msg-font-size: 24px; }
        body { background: #000; color: white; margin: 0; overflow-x: hidden; font-family: sans-serif; }
        
        /* VIEWPORT PRINCIPAL */
        #viewport {
            position: relative; width: 854px; height: 480px; 
            background: #000; margin: 10px auto; overflow: hidden;
            border: 2px solid #333; box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        /* STRATURI FUNDAL (z-index mic) */
        #bg-video, #bg-img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #color-overlay { position: absolute; inset: 0; background: var(--main-color); mix-blend-mode: overlay; opacity: 0.3; z-index: 2; pointer-events: none; }

        /* ELEMENTE MOBILE (z-index mediu) */
        #webcam-layer { position: absolute; z-index: 10; cursor: move; border: 1px solid rgba(255,255,255,0.2); }
        #circle-group { position: absolute; z-index: 20; cursor: move; display: flex; align-items: center; justify-content: center; }
        #radial-canvas { position: absolute; z-index: 19; pointer-events: none; }
        #draggable-text { position: absolute; z-index: 30; cursor: move; font-weight: bold; text-shadow: 2px 2px 5px #000; }

        /* CASETA MESAJE (z-index MAXIM - MEREU DEASUPRA) */
        #message-layer {
            position: absolute; z-index: 999999 !important; 
            background: rgba(0, 0, 0, 0.9); border-left: 8px solid var(--main-color);
            padding: 20px; border-radius: 0 15px 15px 0;
            min-width: 280px; max-width: 480px; cursor: move;
            display: none; box-shadow: 0 0 40px rgba(0,0,0,0.9);
        }
        #msg-author { color: var(--main-color); font-weight: bold; font-size: 18px; display: block; margin-bottom: 5px; text-transform: uppercase; }
        #msg-text { color: white; font-size: var(--msg-font-size); font-style: italic; line-height: 1.3; }

        /* UI CONTROLS */
        .ui { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; width: 900px; margin: 10px auto; background: #111; padding: 15px; border-radius: 10px; border-top: 4px solid var(--main-color); }
        .cube { background: #1a1a1a; padding: 10px; border-radius: 5px; font-size: 11px; display: flex; flex-direction: column; gap: 6px; }
        h4 { color: var(--main-color); text-transform: uppercase; text-align: center; border-bottom: 1px solid #333; margin-bottom: 5px; }
        button { background: #333; color: white; padding: 6px; border-radius: 4px; font-weight: bold; cursor: pointer; border: 1px solid #444; }
        button:hover { background: var(--main-color); color: black; }
        input { background: #000; color: white; border: 1px solid #333; padding: 4px; border-radius: 3px; }
        input[type="range"] { cursor: pointer; }
    </style>
</head>
<body>

    <div id="viewport">
        <video id="bg-video" autoplay loop muted style="display:none;"></video>
        <img id="bg-img" src="" style="display:none;">
        <div id="color-overlay"></div>

        <div id="webcam-layer" style="top:20px; left:20px; width:220px; height:160px; background:#111;">
            <video id="v-src" autoplay playsinline style="width:100%; height:100%; object-fit:cover;"></video>
        </div>

        <div id="circle-group" style="top:100px; left:300px; width:220px; height:220px;">
            <canvas id="radial-canvas" width="450" height="450"></canvas>
            <div id="inner-circle" style="width:140px; height:140px; border-radius:50%; border:4px solid var(--main-color); overflow:hidden; background:#000;">
                <img id="inner-img" style="width:100%; height:100%; object-fit:cover; display:none;">
            </div>
        </div>

        <div id="draggable-text" style="bottom:30px; left:300px; font-size:32px;">STUDIO MV PRO</div>

        <div id="message-layer" style="top:50px; left:50px;">
            <span id="msg-author">NUME</span>
            <span id="msg-text">Mesajul tău apare aici!</span>
        </div>
    </div>

    <div class="ui">
        <div class="cube"><h4>1. Fundal V</h4><input type="file" accept="video/*" onchange="loadV(this)"><button onclick="show('bg-video')">VIDEO ON</button></div>
        <div class="cube"><h4>2. Fundal P</h4><input type="file" accept="image/*" onchange="loadI(this)"><button onclick="show('bg-img')">FOTO ON</button></div>
        <div class="cube"><h4>3. Webcam</h4><button onclick="startCam()" style="background:#ffaa00; color:000">START CAMERA</button><span>Scale:</span><input type="range" min="0.5" max="2" step="0.1" value="1" oninput="scale('webcam-layer', this.value)"></div>
        <div class="cube"><h4>4. Cerc/VU</h4><input type="file" accept="image/*" onchange="loadC(this)"><button onclick="document.getElementById('inner-img').style.display='block'">POZĂ ON</button><span>Bounce:</span><input type="range" min="0" max="10" value="4" id="bp"></div>
        <div class="cube"><h4>5. Text Studio</h4><input type="text" placeholder="Text..." oninput="document.getElementById('draggable-text').innerText=this.value"><span>Mărime:</span><input type="range" min="20" max="100" value="32" oninput="document.getElementById('draggable-text').style.fontSize=this.value+'px'"></div>
        <div class="cube">
            <h4>6. Mesaje Live</h4>
            <input type="text" id="ev-id" value="test_dj" onchange="setDb(this.value)">
            <span>Durată (sec):</span><input type="range" min="3" max="30" value="10" id="dur">
            <span style="color:#ffaa00">MĂRIME TEXT MESAJ:</span>
            <input type="range" min="16" max="60" value="24" oninput="document.documentElement.style.setProperty('--msg-font-size', this.value+'px')">
        </div>
    </div>

    <script>
        // FIREBASE LOGIC
        firebase.initializeApp({ databaseURL: "https://felicitari-nunta-default-rtdb.firebaseio.com" });
        let db = firebase.database().ref('test_dj');
        let timer;

        function setDb(id) { db.off(); db = firebase.database().ref(id); listen(); }
        function listen() {
            db.limitToLast(1).on('child_added', (s) => {
                const d = s.val();
                const l = document.getElementById('message-layer');
                document.getElementById('msg-author').innerText = d.author;
                document.getElementById('msg-text').innerText = `"${d.text}"`;
                l.style.display = 'block';
                if(timer) clearTimeout(timer);
                timer = setTimeout(() => { l.style.display = 'none'; }, document.getElementById('dur').value * 1000);
            });
        }

        // MEDIA LOADERS
        function loadV(i){ const v=document.getElementById('bg-video'); v.src=URL.createObjectURL(i.files[0]); v.style.display='block'; document.getElementById('bg-img').style.display='none'; }
        function loadI(i){ const img=document.getElementById('bg-img'); img.src=URL.createObjectURL(i.files[0]); img.style.display='block'; document.getElementById('bg-video').style.display='none'; }
        function loadC(i){ const img=document.getElementById('inner-img'); img.src=URL.createObjectURL(i.files[0]); img.style.display='block'; }
        function show(id){ document.getElementById('bg-video').style.display='none'; document.getElementById('bg-img').style.display='none'; document.getElementById(id).style.display='block'; }
        function scale(id, v){ document.getElementById(id).style.transform = `scale(${v})`; }

        // CAMERA & AUDIO
        function startCam() {
            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(s => {
                document.getElementById('v-src').srcObject = s;
                initAudio(s);
                listen();
            });
        }

        // VU-METRU (REPARAT)
        function initAudio(s) {
            const ctx = new AudioContext();
            const src = ctx.createMediaStreamSource(s);
            const ans = ctx.createAnalyser();
            ans.fftSize = 256;
            src.connect(ans);
            const data = new Uint8Array(ans.frequencyBinCount);
            const can = document.getElementById('radial-canvas');
            const c = can.getContext('2d');

            function draw() {
                requestAnimationFrame(draw);
                ans.getByteFrequencyData(data);
                c.clearRect(0,0,450,450);
                let sum = 0; for(let i=0; i<20; i++) sum += data[i];
                let v = sum/20;
                document.getElementById('circle-group').style.transform = `scale(${1 + (v/255) * (document.getElementById('bp').value/5)})`;
                
                c.strokeStyle = '#ffaa00'; c.lineWidth = 4;
                for(let i=0; i<60; i++){
                    let a = (i*6)*Math.PI/180;
                    let len = data[i] * 0.5;
                    c.beginPath();
                    c.moveTo(225+Math.cos(a)*80, 225+Math.sin(a)*80);
                    c.lineTo(225+Math.cos(a)*(80+len), 225+Math.sin(a)*(80+len));
                    c.stroke();
                }
            }
            draw();
        }

        // DRAG & DROP
        function drag(e) {
            let p1=0, p2=0, p3=0, p4=0;
            e.onmousedown = (m) => {
                m.preventDefault(); p3=m.clientX; p4=m.clientY;
                document.onmouseup = () => { document.onmouseup=null; document.onmousemove=null; };
                document.onmousemove = (m) => {
                    p1=p3-m.clientX; p2=p4-m.clientY; p3=m.clientX; p4=m.clientY;
                    e.style.top=(e.offsetTop-p2)+"px"; e.style.left=(e.offsetLeft-p1)+"px";
                };
            };
        }
        drag(document.getElementById('message-layer'));
        drag(document.getElementById('circle-group'));
        drag(document.getElementById('webcam-layer'));
        drag(document.getElementById('draggable-text'));
    </script>
</body>
</html>
